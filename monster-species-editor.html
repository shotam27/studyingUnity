<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monster Species Manager - Local Edition</title>
    <link rel="stylesheet" href="quest-manager.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ‰ Monster Species Manager</h1>
            <p>ãƒ­ãƒ¼ã‚«ãƒ«JSONãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†ãƒ„ãƒ¼ãƒ« - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸è¦ã®ã‚·ãƒ³ãƒ—ãƒ«ç®¡ç†</p>
        </div>

        <!-- ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="file-controls">
            <input type="file" id="fileInput" accept=".json" style="display: none;">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                ğŸ“ JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            </button>
            <button class="btn btn-primary" onclick="openWritableFile()">
                ğŸ“‚ é–‹ã„ã¦ä¸Šæ›¸ã
            </button>
            <small style="margin-left:12px;color:#eef;opacity:0.9;">(å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ãªã‚‰é¸æŠãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥ä¸Šæ›¸ãä¿å­˜ã§ãã¾ã™)</small>
            <button class="btn btn-success" onclick="saveToFile()">
                ğŸ’¾ JSONãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            </button>
            <button class="btn btn-warning" onclick="exportBackup()">
                ğŸ“¤ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
            </button>
            <span id="fileStatus">ãƒ•ã‚¡ã‚¤ãƒ«æœªèª­ã¿è¾¼ã¿</span>
        </div>

        <!-- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
        <div id="dropZone">
            <p>ğŸ“„ JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                ã¾ãŸã¯ä¸Šã®ã€ŒJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
            </p>
        </div>

        <!-- æ“ä½œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div class="controls">
            <button class="btn btn-primary" onclick="openAddModal()">
                â• æ–°ã—ã„ç¨®æ—ã‚’è¿½åŠ 
            </button>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="ğŸ” ç¨®æ—åã§æ¤œç´¢..." oninput="filterSpecies()">
            </div>
            <!-- ã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›å¼ã«å¤‰æ›´ -->
            <input type="text" id="categoryFilter" class="form-input" placeholder="ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆä¾‹: Dragonï¼‰" oninput="filterSpecies()">
        </div>

        <!-- ç¨®æ—ä¸€è¦§ -->
        <div id="speciesGrid" class="species-grid">
            <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ç¨®æ—ã‚«ãƒ¼ãƒ‰ -->
        </div>

        <!-- çµ±è¨ˆæƒ…å ± -->
        <div id="statistics" style="margin-top: 30px; padding: 20px; background: white; border-radius: 10px;">
            <h3>ğŸ“Š çµ±è¨ˆæƒ…å ±</h3>
            <div id="statsContent"></div>
        </div>
    </div>

    <!-- ç¨®æ—ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">ç¨®æ—ã‚’ç·¨é›†</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            
            <form id="speciesForm">
                <div class="form-group">
                    <label class="form-label">ç¨®æ—å *</label>
                    <input type="text" id="speciesName" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">èª¬æ˜</label>
                    <textarea id="speciesDescription" class="form-textarea" 
                              placeholder="ã“ã®ç¨®æ—ã®ç‰¹å¾´ã‚„èƒŒæ™¯ã‚’å…¥åŠ›..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">HP *</label>
                        <input type="number" id="speciesHP" class="form-input" min="1" max="999" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ATK *</label>
                        <input type="number" id="speciesATK" class="form-input" min="0" max="999" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">DEF *</label>
                        <input type="number" id="speciesDEF" class="form-input" min="0" max="999" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SPD *</label>
                        <input type="number" id="speciesSPD" class="form-input" min="0" max="999" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å¼±ç‚¹ *</label>
                        <input type="text" id="speciesWeakness" class="form-input" required placeholder="ä¾‹: Water">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¼·ã¿ *</label>
                        <input type="text" id="speciesStrength" class="form-input" required placeholder="ä¾‹: Fire">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ãƒ¬ã‚¢ãƒªãƒ†ã‚£ *</label>
                        <select id="speciesRarity" class="form-select" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="Common">Common</option>
                            <option value="Uncommon">Uncommon</option>
                            <option value="Rare">Rare</option>
                            <option value="Epic">Epic</option>
                            <option value="Legendary">Legendary</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ã‚«ãƒ†ã‚´ãƒª *</label>
                        <input type="text" id="speciesCategory" class="form-input" required placeholder="ä¾‹: Dragon">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="button" class="btn btn-primary" onclick="saveSpecies()">
                        ğŸ’¾ ä¿å­˜
                    </button>
                    <button type="button" class="btn" onclick="closeModal()" 
                            style="background-color: #e2e8f0; color: #4a5568;">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button type="button" class="btn btn-danger" id="deleteBtn" 
                            onclick="deleteCurrentSpecies()" style="margin-left: auto;">
                        ğŸ—‘ï¸ å‰Šé™¤
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ -->
    <div class="status-bar">
        <div id="statusLeft">æº–å‚™å®Œäº†</div>
        <div id="statusRight">
            <span id="speciesCount">ç¨®æ—æ•°: 0</span> | 
            <span id="lastSaved">æœªä¿å­˜</span>
        </div>
    </div>

    <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let speciesData = [];
    let currentEditingIndex = -1;
    let filteredData = [];
    let currentFileHandle = null; // File System Access API handle when available
    let currentFileName = null; // fallback filename for downloads/status

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            // Try load the project's StreamingAssets default JSON first
            loadDefaultStreamingAssets().then(found => {
                if (!found) loadSampleData();
                updateDisplay();
            });
        });

        // Attempt to fetch Assets/StreamingAssets/monster-species.json when served via local server
        async function loadDefaultStreamingAssets() {
            const url = '/Assets/StreamingAssets/monster-species.json';
            try {
                const resp = await fetch(url, { cache: 'no-store' });
                if (!resp.ok) return false;
                const data = await resp.json();
                if (Array.isArray(data)) {
                    speciesData = data;
                    currentFileName = 'monster-species.json';
                    updateFileStatus('Loaded: ' + url);
                    updateStatus('StreamingAssets JSON ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                    return true;
                }
            } catch (e) {
                // ignore â€” likely not available over file:// or server
            }
            return false;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleFileDrop);
            dropZone.addEventListener('dragleave', handleDragLeave);
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadSampleData() {
            speciesData = [
                {
                    id: "flame_dragon_001",
                    name: "Flame Dragon",
                    description: "A powerful fire-breathing dragon with ancient wisdom",
                    basicStatus: { maxHP: 150, atk: 120, def: 80, spd: 70 },
                    weakness: "Water",
                    strength: "Fire",
                    rarity: "Epic",
                    category: "Dragon",
                    createdAt: new Date().toISOString()
                },
                {
                    id: "forest_wolf_001",
                    name: "Forest Wolf",
                    description: "A swift woodland predator with keen senses",
                    basicStatus: { maxHP: 80, atk: 75, def: 55, spd: 90 },
                    weakness: "Fire",
                    strength: "Earth",
                    rarity: "Common",
                    category: "Beast",
                    createdAt: new Date().toISOString()
                },
                {
                    id: "crystal_golem_001",
                    name: "Crystal Golem",
                    description: "A mystical construct made of living crystal",
                    basicStatus: { maxHP: 200, atk: 60, def: 120, spd: 30 },
                    weakness: "Dark",
                    strength: "Light",
                    rarity: "Rare",
                    category: "Elemental",
                    createdAt: new Date().toISOString()
                }
            ];
            updateFileStatus('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ¸ˆã¿');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                readJSONFile(file);
            }
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†
        function handleDragOver(event) {
            event.preventDefault();
            document.getElementById('dropZone').classList.add('dragover');
        }

        // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–å‡¦ç†
        function handleDragLeave(event) {
            event.preventDefault();
            document.getElementById('dropZone').classList.remove('dragover');
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
        function handleFileDrop(event) {
            event.preventDefault();
            document.getElementById('dropZone').classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                readJSONFile(files[0]);
            }
        }

        // JSONãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        function readJSONFile(file) {
            if (!file.name.endsWith('.json')) {
                alert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        speciesData = data;
                        updateDisplay();
                        currentFileName = file.name;
                        updateFileStatus(`${file.name} èª­ã¿è¾¼ã¿å®Œäº†`);
                        updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ');
                    } else {
                        alert('ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ï¼ˆé…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰');
                    }
                } catch (error) {
                    alert('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Open a file with write permission using the File System Access API (best-effort)
        async function openWritableFile() {
            if (!window.showOpenFilePicker) {
                alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ç›´æ¥ä¸Šæ›¸ãä¿å­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚é€šå¸¸ã®ã€ŒJSONã‚’èª­ã¿è¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ä¿å­˜æ™‚ã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚');
                return;
            }

            try {
                const [handle] = await window.showOpenFilePicker({
                    types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }],
                    excludeAcceptAllOption: false,
                    multiple: false
                });
                if (!handle) return;
                currentFileHandle = handle;

                // read file content
                const file = await handle.getFile();
                currentFileName = file.name || currentFileName;
                const text = await file.text();
                try {
                    const data = JSON.parse(text);
                    if (Array.isArray(data)) {
                        speciesData = data;
                        updateDisplay();
                        updateFileStatus(`${currentFileName} ã‚’é–‹ãã¾ã—ãŸ (ä¸Šæ›¸ãå¯èƒ½)`);
                        updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿æˆåŠŸ (ä¸Šæ›¸ãå¯èƒ½)');
                    } else {
                        alert('é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                    }
                } catch (e) {
                    alert('JSONè§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
                }
            } catch (err) {
                console.warn('openWritableFile cancelled or failed', err);
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜
        async function saveToFile() {
            // backward-compatible alias
            await saveToCurrentFile();
        }

        // Save speciesData to the currently opened file if possible, otherwise download
        async function saveToCurrentFile() {
            const dataStr = JSON.stringify(speciesData, null, 2);

            // If we already have an FS handle, write to it
            if (currentFileHandle && currentFileHandle.createWritable) {
                try {
                    const writable = await currentFileHandle.createWritable();
                    await writable.write(dataStr);
                    await writable.close();
                    updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãä¿å­˜ã—ã¾ã—ãŸ');
                    updateLastSaved();
                    updateFileStatus(`${currentFileName || 'é–‹ã„ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«' } ã«ä¿å­˜`);
                    return;
                } catch (err) {
                    console.warn('write via handle failed, falling back to other methods', err);
                }
            }

            // If File System Access API is available, try to obtain a handle to the project's monster-species.json
            if (!currentFileHandle && window.showOpenFilePicker) {
                try {
                    // Ask the user to select the existing monster-species.json in the project folder
                    const [handle] = await window.showOpenFilePicker({
                        multiple: false,
                        types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
                    });
                    if (handle) {
                        currentFileHandle = handle;
                        currentFileName = handle.name || 'monster-species.json';
                    }
                } catch (e) {
                    // user cancelled or not permitted; fall through to save dialog/download
                    console.debug('openFilePicker cancelled or failed', e && e.message);
                }
            }

            // If we now have a handle (either earlier opened or just selected), write to it
            if (currentFileHandle && currentFileHandle.createWritable) {
                try {
                    const writable = await currentFileHandle.createWritable();
                    await writable.write(dataStr);
                    await writable.close();
                    updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãä¿å­˜ã—ã¾ã—ãŸ');
                    updateLastSaved();
                    updateFileStatus(`${currentFileName || 'é–‹ã„ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«' } ã«ä¿å­˜`);
                    return;
                } catch (err) {
                    console.warn('write via handle failed, falling back to other methods', err);
                }
            }

            // Fallback: trigger download (user must replace file manually)
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFileName || ('monster-species-' + new Date().toISOString().split('T')[0] + '.json');
            a.click();
            URL.revokeObjectURL(url);
            updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼ˆä¸Šæ›¸ãä¸å¯ï¼‰');
            updateLastSaved();
        }

        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
        function exportBackup() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const dataStr = JSON.stringify(speciesData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `monster-species-backup-${timestamp}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            updateStatus('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå®Œäº†');
        }

        // è¡¨ç¤ºæ›´æ–°
        function updateDisplay() {
            filterSpecies();
            updateStatistics();
            updateSpeciesCount();
        }

        // ç¨®æ—ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterSpecies() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;

            filteredData = speciesData.filter(species => {
                const matchesSearch = species.name.toLowerCase().includes(searchTerm) ||
                                    species.description.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || species.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            renderSpeciesGrid();
        }

        // ç¨®æ—ã‚°ãƒªãƒƒãƒ‰æç”»ï¼ˆç”»åƒã¯åŒåPNGã‚’æ¢ã—ã¦è¡¨ç¤ºã€è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ï¼‰
        function renderSpeciesGrid() {
            const grid = document.getElementById('speciesGrid');

            if (filteredData.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                        <p style="font-size: 1.2em;">ğŸ” è©²å½“ã™ã‚‹ç¨®æ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
                        <p>æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã™ã‚‹ã‹ã€æ–°ã—ã„ç¨®æ—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredData.map((species, index) => `
                <div class="species-card">
                    <div style="display:flex;gap:12px;align-items:center;">
                        <img id="species-img-${index}" src="${getNoImageDataUrl()}" alt="noimage" style="width:64px;height:64px;object-fit:cover;border-radius:6px;background:#eee;" />
                        <div style="flex:1;">
                            <div class="species-name">${escapeHtml(species.name || '')}</div>
                            <div class="species-category">${escapeHtml(species.category || '')}</div>
                        </div>
                        <div class="element-tag ${species.rarity.toLowerCase()}" style="background-color: ${getRarityColor(species.rarity)};">
                            ${escapeHtml(species.rarity)}
                        </div>
                    </div>

                    <div class="species-stats">
                        <div class="stat-item"><span class="stat-label">HP</span><span class="stat-value">${species.basicStatus.maxHP}</span></div>
                        <div class="stat-item"><span class="stat-label">ATK</span><span class="stat-value">${species.basicStatus.atk}</span></div>
                        <div class="stat-item"><span class="stat-label">DEF</span><span class="stat-value">${species.basicStatus.def}</span></div>
                        <div class="stat-item"><span class="stat-label">SPD</span><span class="stat-value">${species.basicStatus.spd}</span></div>
                    </div>

                    <div class="species-elements">
                        <div class="element-tag weakness">å¼±ç‚¹: ${escapeHtml(species.weakness)}</div>
                        <div class="element-tag strength">å¼·ã¿: ${escapeHtml(species.strength)}</div>
                    </div>

                    ${species.description ? `
                        <div style="margin: 10px 0; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 0.9em; color: #666;">
                            ${escapeHtml(species.description)}
                        </div>
                    ` : ''}

                    <div class="species-actions">
                        <button class="btn btn-primary" onclick="editSpecies(${speciesData.indexOf(species)})">âœï¸ ç·¨é›†</button>
                        <button class="btn btn-danger" onclick="deleteSpecies(${speciesData.indexOf(species)})">ğŸ—‘ï¸ å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');

            // éåŒæœŸã§å„ç¨®æ—ã«å¯¾å¿œã™ã‚‹ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã—ã¦ img.src ã‚’å·®ã—æ›¿ãˆã‚‹
            filteredData.forEach((species, index) => {
                findImageUrlForSpecies(species).then(url => {
                    if (!url) return;
                    const img = document.getElementById(`species-img-${index}`);
                    if (img) img.src = url;
                }).catch(() => {
                    // ignore
                });
            });
        }

        // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function escapeHtml(str) {
            return String(str || '').replace(/[&<>"']/g, function(m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
        }

        // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€SVGã‚’DataURLã§è¿”ã™
        function getNoImageDataUrl() {
            const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128'><rect width='100%' height='100%' fill='%23f3f4f6'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%239ca3af' font-family='Arial, Helvetica, sans-serif' font-size='12'>No Image</text></svg>`;
            return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        }

        // ç¨®æ—ã«å¯¾å¿œã™ã‚‹ç”»åƒå€™è£œã‚’é †ã«è©¦ã—ã¦å­˜åœ¨ã™ã‚‹æœ€åˆã®URLã‚’è¿”ã™ï¼ˆãªã‘ã‚Œã° nullï¼‰
        async function findImageUrlForSpecies(species) {
            // Search only in Assets/Images by species name (no id search), try common extensions
            const nameRaw = (species.name || '').trim();
            if (!nameRaw) return null;
            const nameSafe = nameRaw.replace(/[^a-zA-Z0-9_\-\.]/g, '_');
            const nameLower = nameSafe.toLowerCase();

            const exts = ['png', 'jpg', 'jpeg', 'webp'];
            const candidates = [];

            // First try URL-encoded raw name (supports Japanese filenames)
            const encodedName = encodeURIComponent(nameRaw);
            for (const e of exts) candidates.push(`Assets/Images/${encodedName}.${e}`);

            // Then try sanitized versions
            for (const e of exts) {
                candidates.push(`Assets/Images/${nameSafe}.${e}`);
                candidates.push(`Assets/Images/${nameLower}.${e}`);
            }

            for (const p of candidates) {
                try {
                    console.debug('Checking image:', p);
                    const r = await fetch(p, { method: 'GET' });
                    if (r && r.ok) {
                        console.debug('Found image for', nameRaw, '->', p);
                        return p;
                    }
                } catch (e) {
                    // file:// or CORS may fail â€” ignore and continue
                    console.debug('Fetch failed for', p, e && e.message);
                }
            }
            return null;
        }

        // ãƒ¬ã‚¢ãƒªãƒ†ã‚£è‰²å–å¾—
        function getRarityColor(rarity) {
            const colors = {
                'Common': '#e2e8f0',
                'Uncommon': '#d69e2e',
                'Rare': '#3182ce',
                'Epic': '#805ad5',
                'Legendary': '#e53e3e'
            };
            return colors[rarity] || '#e2e8f0';
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStatistics() {
            const stats = document.getElementById('statsContent');
            const totalSpecies = speciesData.length;
            const categoryCount = {};
            const rarityCount = {};
            let totalHP = 0;

            speciesData.forEach(species => {
                categoryCount[species.category] = (categoryCount[species.category] || 0) + 1;
                rarityCount[species.rarity] = (rarityCount[species.rarity] || 0) + 1;
                totalHP += species.basicStatus.maxHP;
            });

            const avgHP = totalSpecies > 0 ? Math.round(totalHP / totalSpecies) : 0;

            stats.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div>
                        <h4>ğŸ“Š åŸºæœ¬çµ±è¨ˆ</h4>
                        <p>ç·ç¨®æ—æ•°: ${totalSpecies}</p>
                        <p>å¹³å‡HP: ${avgHP}</p>
                        <p>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµæœ: ${filteredData.length}</p>
                    </div>
                    <div>
                        <h4>ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªåˆ¥</h4>
                        ${Object.entries(categoryCount).map(([cat, count]) => 
                            `<p>${cat}: ${count}</p>`
                        ).join('')}
                    </div>
                    <div>
                        <h4>ğŸ’ ãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¥</h4>
                        ${Object.entries(rarityCount).map(([rarity, count]) => 
                            `<p>${rarity}: ${count}</p>`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
        function openAddModal() {
            currentEditingIndex = -1;
            document.getElementById('modalTitle').textContent = 'æ–°ã—ã„ç¨®æ—ã‚’è¿½åŠ ';
            document.getElementById('deleteBtn').style.display = 'none';
            clearForm();
            document.getElementById('editModal').style.display = 'block';
        }

        function editSpecies(index) {
            currentEditingIndex = index;
            const species = speciesData[index];
            document.getElementById('modalTitle').textContent = 'ç¨®æ—ã‚’ç·¨é›†';
            document.getElementById('deleteBtn').style.display = 'block';
            populateForm(species);
            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            clearForm();
        }

        function clearForm() {
            document.getElementById('speciesForm').reset();
        }

        function populateForm(species) {
            document.getElementById('speciesName').value = species.name;
            document.getElementById('speciesDescription').value = species.description || '';
            document.getElementById('speciesHP').value = species.basicStatus.maxHP;
            document.getElementById('speciesATK').value = species.basicStatus.atk;
            document.getElementById('speciesDEF').value = species.basicStatus.def;
            document.getElementById('speciesSPD').value = species.basicStatus.spd;
            document.getElementById('speciesWeakness').value = species.weakness;
            document.getElementById('speciesStrength').value = species.strength;
            document.getElementById('speciesRarity').value = species.rarity;
            document.getElementById('speciesCategory').value = species.category;
        }

        function saveSpecies() {
            // ãƒ•ã‚©ãƒ¼ãƒ æ¤œè¨¼
            const form = document.getElementById('speciesForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const speciesData_new = {
                id: currentEditingIndex === -1 ? 
                    'species_' + Date.now() : 
                    speciesData[currentEditingIndex].id,
                name: document.getElementById('speciesName').value,
                description: document.getElementById('speciesDescription').value,
                basicStatus: {
                    maxHP: parseInt(document.getElementById('speciesHP').value),
                    atk: parseInt(document.getElementById('speciesATK').value),
                    def: parseInt(document.getElementById('speciesDEF').value),
                    spd: parseInt(document.getElementById('speciesSPD').value)
                },
                weakness: document.getElementById('speciesWeakness').value,
                strength: document.getElementById('speciesStrength').value,
                rarity: document.getElementById('speciesRarity').value,
                category: document.getElementById('speciesCategory').value,
                createdAt: currentEditingIndex === -1 ? 
                    new Date().toISOString() : 
                    speciesData[currentEditingIndex].createdAt,
                updatedAt: new Date().toISOString()
            };

            if (currentEditingIndex === -1) {
                speciesData.push(speciesData_new);
                updateStatus('æ–°ã—ã„ç¨®æ—ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
            } else {
                speciesData[currentEditingIndex] = speciesData_new;
                updateStatus('ç¨®æ—æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            }

            closeModal();
            updateDisplay();
            // attempt to persist to opened file
            saveToCurrentFile();
        }

        function deleteCurrentSpecies() {
            if (currentEditingIndex === -1) return;
            
            if (confirm('ã“ã®ç¨®æ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                const deletedName = speciesData[currentEditingIndex].name;
                speciesData.splice(currentEditingIndex, 1);
                closeModal();
                updateDisplay();
                updateStatus(`ç¨®æ—ã€Œ${deletedName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                // persist change if file is opened
                saveToCurrentFile();
            }
        }

        function deleteSpecies(index) {
            if (confirm('ã“ã®ç¨®æ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                const deletedName = speciesData[index].name;
                speciesData.splice(index, 1);
                updateDisplay();
                updateStatus(`ç¨®æ—ã€Œ${deletedName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                saveToCurrentFile();
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function updateStatus(message) {
            document.getElementById('statusLeft').textContent = message;
            setTimeout(() => {
                document.getElementById('statusLeft').textContent = 'æº–å‚™å®Œäº†';
            }, 3000);
        }

        function updateFileStatus(status) {
            document.getElementById('fileStatus').textContent = status;
        }

        function updateSpeciesCount() {
            document.getElementById('speciesCount').textContent = `ç¨®æ—æ•°: ${speciesData.length}`;
        }

        function updateLastSaved() {
            const now = new Date().toLocaleString();
            document.getElementById('lastSaved').textContent = `æœ€çµ‚ä¿å­˜: ${now}`;
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 's') {
                event.preventDefault();
                saveToFile();
            }
            if (event.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
