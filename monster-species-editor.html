<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monster Species Manager - Local Edition</title>
    <link rel="stylesheet" href="quest-manager.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🐉 Monster Species Manager</h1>
            <p>ローカルJSONファイル編集ツール - データベース不要のシンプル管理</p>
        </div>

        <!-- ファイル操作コントロール -->
        <div class="file-controls">
            <input type="file" id="fileInput" accept=".json" style="display: none;">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                📁 JSONファイルを読み込み
            </button>
            <button class="btn btn-primary" onclick="openWritableFile()">
                📂 開いて上書き
            </button>
            <small style="margin-left:12px;color:#eef;opacity:0.9;">(対応ブラウザなら選択ファイルを直接上書き保存できます)</small>
            <button class="btn btn-success" onclick="saveToFile()">
                💾 JSONファイルに保存
            </button>
            <button class="btn btn-warning" onclick="exportBackup()">
                📤 バックアップ作成
            </button>
            <span id="fileStatus">ファイル未読み込み</span>
        </div>

        <!-- ドラッグ&ドロップエリア -->
        <div id="dropZone">
            <p>📄 JSONファイルをここにドラッグ&ドロップ</p>
            <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
                または上の「JSONファイルを読み込み」ボタンをクリック
            </p>
        </div>

        <!-- 操作コントロール -->
        <div class="controls">
            <button class="btn btn-primary" onclick="openAddModal()">
                ➕ 新しい種族を追加
            </button>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="🔍 種族名で検索..." oninput="filterSpecies()">
            </div>
            <!-- カテゴリを入力式に変更 -->
            <input type="text" id="categoryFilter" class="form-input" placeholder="カテゴリでフィルター（例: Dragon）" oninput="filterSpecies()">
        </div>

        <!-- 種族一覧 -->
        <div id="speciesGrid" class="species-grid">
            <!-- 動的に生成される種族カード -->
        </div>

        <!-- 統計情報 -->
        <div id="statistics" style="margin-top: 30px; padding: 20px; background: white; border-radius: 10px;">
            <h3>📊 統計情報</h3>
            <div id="statsContent"></div>
        </div>
    </div>

    <!-- 種族編集モーダル -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">種族を編集</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            
            <form id="speciesForm">
                <div class="form-group">
                    <label class="form-label">種族名 *</label>
                    <input type="text" id="speciesName" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label">説明</label>
                    <textarea id="speciesDescription" class="form-textarea" 
                              placeholder="この種族の特徴や背景を入力..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">HP *</label>
                        <input type="number" id="speciesHP" class="form-input" min="1" max="999" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ATK *</label>
                        <input type="number" id="speciesATK" class="form-input" min="0" max="999" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">DEF *</label>
                        <input type="number" id="speciesDEF" class="form-input" min="0" max="999" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">SPD *</label>
                        <input type="number" id="speciesSPD" class="form-input" min="0" max="999" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">弱点 *</label>
                        <input type="text" id="speciesWeakness" class="form-input" required placeholder="例: Water">
                    </div>
                    <div class="form-group">
                        <label class="form-label">強み *</label>
                        <input type="text" id="speciesStrength" class="form-input" required placeholder="例: Fire">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">レアリティ *</label>
                        <select id="speciesRarity" class="form-select" required>
                            <option value="">選択してください</option>
                            <option value="Common">Common</option>
                            <option value="Uncommon">Uncommon</option>
                            <option value="Rare">Rare</option>
                            <option value="Epic">Epic</option>
                            <option value="Legendary">Legendary</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">カテゴリ *</label>
                        <input type="text" id="speciesCategory" class="form-input" required placeholder="例: Dragon">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 30px;">
                    <button type="button" class="btn btn-primary" onclick="saveSpecies()">
                        💾 保存
                    </button>
                    <button type="button" class="btn" onclick="closeModal()" 
                            style="background-color: #e2e8f0; color: #4a5568;">
                        キャンセル
                    </button>
                    <button type="button" class="btn btn-danger" id="deleteBtn" 
                            onclick="deleteCurrentSpecies()" style="margin-left: auto;">
                        🗑️ 削除
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ステータスバー -->
    <div class="status-bar">
        <div id="statusLeft">準備完了</div>
        <div id="statusRight">
            <span id="speciesCount">種族数: 0</span> | 
            <span id="lastSaved">未保存</span>
        </div>
    </div>

    <script>
    // グローバル変数
    let speciesData = [];
    let currentEditingIndex = -1;
    let filteredData = [];
    let currentFileHandle = null; // File System Access API handle when available
    let currentFileName = null; // fallback filename for downloads/status

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            // Try load the project's StreamingAssets default JSON first
            loadDefaultStreamingAssets().then(found => {
                if (!found) loadSampleData();
                updateDisplay();
            });
        });

        // Attempt to fetch Assets/StreamingAssets/monster-species.json when served via local server
        async function loadDefaultStreamingAssets() {
            const url = '/Assets/StreamingAssets/monster-species.json';
            try {
                const resp = await fetch(url, { cache: 'no-store' });
                if (!resp.ok) return false;
                const data = await resp.json();
                if (Array.isArray(data)) {
                    speciesData = data;
                    currentFileName = 'monster-species.json';
                    updateFileStatus('Loaded: ' + url);
                    updateStatus('StreamingAssets JSON を読み込みました');
                    return true;
                }
            } catch (e) {
                // ignore — likely not available over file:// or server
            }
            return false;
        }

        // イベントリスナー設定
    function setupEventListeners() {
            // ファイル入力
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
            
            // ドラッグ&ドロップ
            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleFileDrop);
            dropZone.addEventListener('dragleave', handleDragLeave);
        }

        // サンプルデータ読み込み
        function loadSampleData() {
            speciesData = [
                {
                    id: "flame_dragon_001",
                    name: "Flame Dragon",
                    description: "A powerful fire-breathing dragon with ancient wisdom",
                    basicStatus: { maxHP: 150, atk: 120, def: 80, spd: 70 },
                    weakness: "Water",
                    strength: "Fire",
                    rarity: "Epic",
                    category: "Dragon",
                    createdAt: new Date().toISOString()
                },
                {
                    id: "forest_wolf_001",
                    name: "Forest Wolf",
                    description: "A swift woodland predator with keen senses",
                    basicStatus: { maxHP: 80, atk: 75, def: 55, spd: 90 },
                    weakness: "Fire",
                    strength: "Earth",
                    rarity: "Common",
                    category: "Beast",
                    createdAt: new Date().toISOString()
                },
                {
                    id: "crystal_golem_001",
                    name: "Crystal Golem",
                    description: "A mystical construct made of living crystal",
                    basicStatus: { maxHP: 200, atk: 60, def: 120, spd: 30 },
                    weakness: "Dark",
                    strength: "Light",
                    rarity: "Rare",
                    category: "Elemental",
                    createdAt: new Date().toISOString()
                }
            ];
            updateFileStatus('サンプルデータ読み込み済み');
        }

        // ファイル選択処理
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                readJSONFile(file);
            }
        }

        // ドラッグオーバー処理
        function handleDragOver(event) {
            event.preventDefault();
            document.getElementById('dropZone').classList.add('dragover');
        }

        // ドラッグリーブ処理
        function handleDragLeave(event) {
            event.preventDefault();
            document.getElementById('dropZone').classList.remove('dragover');
        }

        // ファイルドロップ処理
        function handleFileDrop(event) {
            event.preventDefault();
            document.getElementById('dropZone').classList.remove('dragover');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                readJSONFile(files[0]);
            }
        }

        // JSONファイル読み込み
        function readJSONFile(file) {
            if (!file.name.endsWith('.json')) {
                alert('JSONファイルを選択してください');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        speciesData = data;
                        updateDisplay();
                        currentFileName = file.name;
                        updateFileStatus(`${file.name} 読み込み完了`);
                        updateStatus('ファイル読み込み成功');
                    } else {
                        alert('データ形式が正しくありません（配列である必要があります）');
                    }
                } catch (error) {
                    alert('JSONファイルの解析に失敗しました: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Open a file with write permission using the File System Access API (best-effort)
        async function openWritableFile() {
            if (!window.showOpenFilePicker) {
                alert('このブラウザは直接上書き保存に対応していません。通常の「JSONを読み込む」ボタンでファイルを読み込み、保存時はダウンロードになります。');
                return;
            }

            try {
                const [handle] = await window.showOpenFilePicker({
                    types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }],
                    excludeAcceptAllOption: false,
                    multiple: false
                });
                if (!handle) return;
                currentFileHandle = handle;

                // read file content
                const file = await handle.getFile();
                currentFileName = file.name || currentFileName;
                const text = await file.text();
                try {
                    const data = JSON.parse(text);
                    if (Array.isArray(data)) {
                        speciesData = data;
                        updateDisplay();
                        updateFileStatus(`${currentFileName} を開きました (上書き可能)`);
                        updateStatus('ファイル読み込み成功 (上書き可能)');
                    } else {
                        alert('選択したファイルの形式が配列ではありません');
                    }
                } catch (e) {
                    alert('JSON解析に失敗しました: ' + e.message);
                }
            } catch (err) {
                console.warn('openWritableFile cancelled or failed', err);
            }
        }

        // ファイル保存
        async function saveToFile() {
            // backward-compatible alias
            await saveToCurrentFile();
        }

        // Save speciesData to the currently opened file if possible, otherwise download
        async function saveToCurrentFile() {
            const dataStr = JSON.stringify(speciesData, null, 2);

            // If we already have an FS handle, write to it
            if (currentFileHandle && currentFileHandle.createWritable) {
                try {
                    const writable = await currentFileHandle.createWritable();
                    await writable.write(dataStr);
                    await writable.close();
                    updateStatus('ファイルを上書き保存しました');
                    updateLastSaved();
                    updateFileStatus(`${currentFileName || '開いているファイル' } に保存`);
                    return;
                } catch (err) {
                    console.warn('write via handle failed, falling back to other methods', err);
                }
            }

            // If File System Access API is available, try to obtain a handle to the project's monster-species.json
            if (!currentFileHandle && window.showOpenFilePicker) {
                try {
                    // Ask the user to select the existing monster-species.json in the project folder
                    const [handle] = await window.showOpenFilePicker({
                        multiple: false,
                        types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
                    });
                    if (handle) {
                        currentFileHandle = handle;
                        currentFileName = handle.name || 'monster-species.json';
                    }
                } catch (e) {
                    // user cancelled or not permitted; fall through to save dialog/download
                    console.debug('openFilePicker cancelled or failed', e && e.message);
                }
            }

            // If we now have a handle (either earlier opened or just selected), write to it
            if (currentFileHandle && currentFileHandle.createWritable) {
                try {
                    const writable = await currentFileHandle.createWritable();
                    await writable.write(dataStr);
                    await writable.close();
                    updateStatus('ファイルを上書き保存しました');
                    updateLastSaved();
                    updateFileStatus(`${currentFileName || '開いているファイル' } に保存`);
                    return;
                } catch (err) {
                    console.warn('write via handle failed, falling back to other methods', err);
                }
            }

            // Fallback: trigger download (user must replace file manually)
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFileName || ('monster-species-' + new Date().toISOString().split('T')[0] + '.json');
            a.click();
            URL.revokeObjectURL(url);
            updateStatus('ファイルをダウンロードしました（上書き不可）');
            updateLastSaved();
        }

        // バックアップ作成
        function exportBackup() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const dataStr = JSON.stringify(speciesData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `monster-species-backup-${timestamp}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            updateStatus('バックアップ作成完了');
        }

        // 表示更新
        function updateDisplay() {
            filterSpecies();
            updateStatistics();
            updateSpeciesCount();
        }

        // 種族フィルタリング
        function filterSpecies() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;

            filteredData = speciesData.filter(species => {
                const matchesSearch = species.name.toLowerCase().includes(searchTerm) ||
                                    species.description.toLowerCase().includes(searchTerm);
                const matchesCategory = !categoryFilter || species.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            renderSpeciesGrid();
        }

        // 種族グリッド描画（画像は同名PNGを探して表示、見つからなければプレースホルダ）
        function renderSpeciesGrid() {
            const grid = document.getElementById('speciesGrid');

            if (filteredData.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                        <p style="font-size: 1.2em;">🔍 該当する種族が見つかりません</p>
                        <p>検索条件を変更するか、新しい種族を追加してください</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredData.map((species, index) => `
                <div class="species-card">
                    <div style="display:flex;gap:12px;align-items:center;">
                        <img id="species-img-${index}" src="${getNoImageDataUrl()}" alt="noimage" style="width:64px;height:64px;object-fit:cover;border-radius:6px;background:#eee;" />
                        <div style="flex:1;">
                            <div class="species-name">${escapeHtml(species.name || '')}</div>
                            <div class="species-category">${escapeHtml(species.category || '')}</div>
                        </div>
                        <div class="element-tag ${species.rarity.toLowerCase()}" style="background-color: ${getRarityColor(species.rarity)};">
                            ${escapeHtml(species.rarity)}
                        </div>
                    </div>

                    <div class="species-stats">
                        <div class="stat-item"><span class="stat-label">HP</span><span class="stat-value">${species.basicStatus.maxHP}</span></div>
                        <div class="stat-item"><span class="stat-label">ATK</span><span class="stat-value">${species.basicStatus.atk}</span></div>
                        <div class="stat-item"><span class="stat-label">DEF</span><span class="stat-value">${species.basicStatus.def}</span></div>
                        <div class="stat-item"><span class="stat-label">SPD</span><span class="stat-value">${species.basicStatus.spd}</span></div>
                    </div>

                    <div class="species-elements">
                        <div class="element-tag weakness">弱点: ${escapeHtml(species.weakness)}</div>
                        <div class="element-tag strength">強み: ${escapeHtml(species.strength)}</div>
                    </div>

                    ${species.description ? `
                        <div style="margin: 10px 0; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-size: 0.9em; color: #666;">
                            ${escapeHtml(species.description)}
                        </div>
                    ` : ''}

                    <div class="species-actions">
                        <button class="btn btn-primary" onclick="editSpecies(${speciesData.indexOf(species)})">✏️ 編集</button>
                        <button class="btn btn-danger" onclick="deleteSpecies(${speciesData.indexOf(species)})">🗑️ 削除</button>
                    </div>
                </div>
            `).join('');

            // 非同期で各種族に対応する画像ファイルを探して img.src を差し替える
            filteredData.forEach((species, index) => {
                findImageUrlForSpecies(species).then(url => {
                    if (!url) return;
                    const img = document.getElementById(`species-img-${index}`);
                    if (img) img.src = url;
                }).catch(() => {
                    // ignore
                });
            });
        }

        // エスケープユーティリティ
        function escapeHtml(str) {
            return String(str || '').replace(/[&<>"']/g, function(m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
        }

        // プレースホルダSVGをDataURLで返す
        function getNoImageDataUrl() {
            const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='128' height='128'><rect width='100%' height='100%' fill='%23f3f4f6'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='%239ca3af' font-family='Arial, Helvetica, sans-serif' font-size='12'>No Image</text></svg>`;
            return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
        }

        // 種族に対応する画像候補を順に試して存在する最初のURLを返す（なければ null）
        async function findImageUrlForSpecies(species) {
            // Search only in Assets/Images by species name (no id search), try common extensions
            const nameRaw = (species.name || '').trim();
            if (!nameRaw) return null;
            const nameSafe = nameRaw.replace(/[^a-zA-Z0-9_\-\.]/g, '_');
            const nameLower = nameSafe.toLowerCase();

            const exts = ['png', 'jpg', 'jpeg', 'webp'];
            const candidates = [];

            // First try URL-encoded raw name (supports Japanese filenames)
            const encodedName = encodeURIComponent(nameRaw);
            for (const e of exts) candidates.push(`Assets/Images/${encodedName}.${e}`);

            // Then try sanitized versions
            for (const e of exts) {
                candidates.push(`Assets/Images/${nameSafe}.${e}`);
                candidates.push(`Assets/Images/${nameLower}.${e}`);
            }

            for (const p of candidates) {
                try {
                    console.debug('Checking image:', p);
                    const r = await fetch(p, { method: 'GET' });
                    if (r && r.ok) {
                        console.debug('Found image for', nameRaw, '->', p);
                        return p;
                    }
                } catch (e) {
                    // file:// or CORS may fail — ignore and continue
                    console.debug('Fetch failed for', p, e && e.message);
                }
            }
            return null;
        }

        // レアリティ色取得
        function getRarityColor(rarity) {
            const colors = {
                'Common': '#e2e8f0',
                'Uncommon': '#d69e2e',
                'Rare': '#3182ce',
                'Epic': '#805ad5',
                'Legendary': '#e53e3e'
            };
            return colors[rarity] || '#e2e8f0';
        }

        // 統計情報更新
        function updateStatistics() {
            const stats = document.getElementById('statsContent');
            const totalSpecies = speciesData.length;
            const categoryCount = {};
            const rarityCount = {};
            let totalHP = 0;

            speciesData.forEach(species => {
                categoryCount[species.category] = (categoryCount[species.category] || 0) + 1;
                rarityCount[species.rarity] = (rarityCount[species.rarity] || 0) + 1;
                totalHP += species.basicStatus.maxHP;
            });

            const avgHP = totalSpecies > 0 ? Math.round(totalHP / totalSpecies) : 0;

            stats.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <div>
                        <h4>📊 基本統計</h4>
                        <p>総種族数: ${totalSpecies}</p>
                        <p>平均HP: ${avgHP}</p>
                        <p>フィルター結果: ${filteredData.length}</p>
                    </div>
                    <div>
                        <h4>🏷️ カテゴリ別</h4>
                        ${Object.entries(categoryCount).map(([cat, count]) => 
                            `<p>${cat}: ${count}</p>`
                        ).join('')}
                    </div>
                    <div>
                        <h4>💎 レアリティ別</h4>
                        ${Object.entries(rarityCount).map(([rarity, count]) => 
                            `<p>${rarity}: ${count}</p>`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        // モーダル関連
        function openAddModal() {
            currentEditingIndex = -1;
            document.getElementById('modalTitle').textContent = '新しい種族を追加';
            document.getElementById('deleteBtn').style.display = 'none';
            clearForm();
            document.getElementById('editModal').style.display = 'block';
        }

        function editSpecies(index) {
            currentEditingIndex = index;
            const species = speciesData[index];
            document.getElementById('modalTitle').textContent = '種族を編集';
            document.getElementById('deleteBtn').style.display = 'block';
            populateForm(species);
            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            clearForm();
        }

        function clearForm() {
            document.getElementById('speciesForm').reset();
        }

        function populateForm(species) {
            document.getElementById('speciesName').value = species.name;
            document.getElementById('speciesDescription').value = species.description || '';
            document.getElementById('speciesHP').value = species.basicStatus.maxHP;
            document.getElementById('speciesATK').value = species.basicStatus.atk;
            document.getElementById('speciesDEF').value = species.basicStatus.def;
            document.getElementById('speciesSPD').value = species.basicStatus.spd;
            document.getElementById('speciesWeakness').value = species.weakness;
            document.getElementById('speciesStrength').value = species.strength;
            document.getElementById('speciesRarity').value = species.rarity;
            document.getElementById('speciesCategory').value = species.category;
        }

        function saveSpecies() {
            // フォーム検証
            const form = document.getElementById('speciesForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const speciesData_new = {
                id: currentEditingIndex === -1 ? 
                    'species_' + Date.now() : 
                    speciesData[currentEditingIndex].id,
                name: document.getElementById('speciesName').value,
                description: document.getElementById('speciesDescription').value,
                basicStatus: {
                    maxHP: parseInt(document.getElementById('speciesHP').value),
                    atk: parseInt(document.getElementById('speciesATK').value),
                    def: parseInt(document.getElementById('speciesDEF').value),
                    spd: parseInt(document.getElementById('speciesSPD').value)
                },
                weakness: document.getElementById('speciesWeakness').value,
                strength: document.getElementById('speciesStrength').value,
                rarity: document.getElementById('speciesRarity').value,
                category: document.getElementById('speciesCategory').value,
                createdAt: currentEditingIndex === -1 ? 
                    new Date().toISOString() : 
                    speciesData[currentEditingIndex].createdAt,
                updatedAt: new Date().toISOString()
            };

            if (currentEditingIndex === -1) {
                speciesData.push(speciesData_new);
                updateStatus('新しい種族を追加しました');
            } else {
                speciesData[currentEditingIndex] = speciesData_new;
                updateStatus('種族情報を更新しました');
            }

            closeModal();
            updateDisplay();
            // attempt to persist to opened file
            saveToCurrentFile();
        }

        function deleteCurrentSpecies() {
            if (currentEditingIndex === -1) return;
            
            if (confirm('この種族を削除しますか？この操作は取り消せません。')) {
                const deletedName = speciesData[currentEditingIndex].name;
                speciesData.splice(currentEditingIndex, 1);
                closeModal();
                updateDisplay();
                updateStatus(`種族「${deletedName}」を削除しました`);
                // persist change if file is opened
                saveToCurrentFile();
            }
        }

        function deleteSpecies(index) {
            if (confirm('この種族を削除しますか？この操作は取り消せません。')) {
                const deletedName = speciesData[index].name;
                speciesData.splice(index, 1);
                updateDisplay();
                updateStatus(`種族「${deletedName}」を削除しました`);
                saveToCurrentFile();
            }
        }

        // ユーティリティ関数
        function updateStatus(message) {
            document.getElementById('statusLeft').textContent = message;
            setTimeout(() => {
                document.getElementById('statusLeft').textContent = '準備完了';
            }, 3000);
        }

        function updateFileStatus(status) {
            document.getElementById('fileStatus').textContent = status;
        }

        function updateSpeciesCount() {
            document.getElementById('speciesCount').textContent = `種族数: ${speciesData.length}`;
        }

        function updateLastSaved() {
            const now = new Date().toLocaleString();
            document.getElementById('lastSaved').textContent = `最終保存: ${now}`;
        }

        // モーダルの外側をクリックで閉じる
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // キーボードショートカット
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey && event.key === 's') {
                event.preventDefault();
                saveToFile();
            }
            if (event.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>
