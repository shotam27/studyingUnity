<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Quest Manager - Local Edition</title>
    <link rel="stylesheet" href="quest-manager.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📜 Quest Manager</h1>
            <p>ローカルJSONでクエストを管理・編集します（名前・ランク・出現モンスター・報酬）</p>
        </div>

        <div class="file-controls">
            <input type="file" id="fileInput" accept=".json" style="display:none">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">📁 JSONを読み込む</button>
            <button class="btn btn-success" onclick="saveToFile()">💾 JSONに保存</button>
            <button class="btn btn-warning" onclick="exportBackup()">📤 バックアップ</button>
            <span id="fileStatus">ファイル未読み込み</span>
        </div>

        <div id="dropZone">📄 JSONファイルをここにドラッグ&ドロップ</div>

        <div class="controls">
            <button class="btn btn-primary" onclick="openAddModal()">➕ 新しいクエストを追加</button>
            <div class="search-box"><input id="searchInput" placeholder="🔍 クエスト名で検索..." oninput="renderList()"></div>
            <select id="rankFilter" onchange="renderList()"><option value="">全ランク</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
        </div>

        <div id="questGrid" class="quest-grid"></div>

        <!-- Modal -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <h2 id="modalTitle">クエストを追加</h2>
                    <button id="closeModal" class="btn">✖</button>
                </div>

                <div class="form-group"><label class="form-label">名前</label><input id="qName" class="form-input"></div>
                <div class="form-group"><label class="form-label">ランク</label><input id="qRank" class="form-input" type="number" value="1" min="1"></div>

                <div class="form-group"><label class="form-label">出現モンスター (カンマ区切り: Species名)</label><input id="qMonsters" class="form-input" placeholder="Flame Dragon, Slime"></div>

                <div class="form-group"><label class="form-label">報酬 (形式: 名称:x,カンマ区切り)</label><input id="qRewards" class="form-input" placeholder="Gold:100, Flame Scale:1"></div>

                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
                    <button class="btn btn-success" onclick="saveModal()">保存</button>
                    <button class="btn btn-danger" onclick="closeModal()">閉じる</button>
                </div>
            </div>
        </div>

        <div class="status-bar"><div id="statusLeft">Ready</div><div id="statusRight"></div></div>
    </div>

    <script>
        let quests = [];
        let currentFileName = null;
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const modal = document.getElementById('modal');

        fileInput.addEventListener('change', (e) => { const f = e.target.files[0]; if (f) readFile(f); });

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); const f = e.dataTransfer.files[0]; if (f) readFile(f); });

        function readFile(file) {
            const reader = new FileReader();
            reader.onload = () => { try { quests = JSON.parse(reader.result) || []; currentFileName = file.name; document.getElementById('fileStatus').innerText = currentFileName; renderList(); setStatus('Loaded ' + currentFileName); } catch (err) { alert('JSON parse error'); setStatus('Parse error'); } };
            reader.readAsText(file);
        }

        function saveToFile() {
            const blob = new Blob([JSON.stringify(quests, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = currentFileName || 'quests.json';
            a.click();
            setStatus('Saved ' + a.download);
        }

        function exportBackup() { const blob = new Blob([JSON.stringify(quests, null, 2)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (currentFileName ? currentFileName.replace('.json','') + '-backup.json' : 'quests-backup.json'); a.click(); setStatus('Backup exported'); }

        function openAddModal(quest) { document.getElementById('modalTitle').innerText = quest ? 'クエストを編集' : 'クエストを追加'; document.getElementById('qName').value = quest ? quest.Name : ''; document.getElementById('qRank').value = quest ? quest.Rank : 1; document.getElementById('qMonsters').value = quest ? (quest.Monsters || []).map(s=>s).join(', ') : ''; document.getElementById('qRewards').value = quest ? (quest.Rewards || []).map(r=>r.ItemName+':'+r.Quantity).join(', ') : ''; modal.style.display = 'block'; }
        function closeModal() { modal.style.display = 'none'; }

        function saveModal() {
            const name = document.getElementById('qName').value.trim();
            if (!name) { alert('名前必須'); return; }
            const rank = parseInt(document.getElementById('qRank').value) || 1;
            const monsters = document.getElementById('qMonsters').value.split(',').map(s=>s.trim()).filter(s=>s.length>0);
            const rewardsRaw = document.getElementById('qRewards').value.split(',').map(s=>s.trim()).filter(s=>s.length>0);
            const rewards = rewardsRaw.map(r=>{ const parts=r.split(':'); return { ItemName: parts[0].trim(), Quantity: parseInt(parts[1])||1 }; });

            const existing = quests.find(q=>q.Name===name);
            const newQ = { Name: name, Rank: rank, Monsters: monsters, Rewards: rewards };
            if (existing) {
                Object.assign(existing, newQ);
            } else {
                quests.push(newQ);
            }

            closeModal(); renderList(); setStatus('Saved in memory');
        }

        function renderList() {
            const grid = document.getElementById('questGrid'); grid.innerHTML = '';
            const query = document.getElementById('searchInput').value.toLowerCase();
            const rankFilter = document.getElementById('rankFilter').value;
            const filtered = quests.filter(q=> (q.Name||'').toLowerCase().includes(query) && (rankFilter==='' || String(q.Rank)===rankFilter));

            filtered.forEach((q, idx)=>{
                const card = document.createElement('div'); card.className='quest-card';
                const header = document.createElement('div'); header.className='quest-header';
                const nameEl = document.createElement('div'); nameEl.className='quest-name'; nameEl.innerText=q.Name||'Unnamed';
                const rankEl = document.createElement('div'); rankEl.className='quest-rank'; rankEl.innerText='Rank '+(q.Rank||1);
                header.appendChild(nameEl); header.appendChild(rankEl);
                card.appendChild(header);

                const body = document.createElement('div'); body.className='quest-body';
                const mons = document.createElement('div'); mons.className='row'; mons.innerHTML=(q.Monsters && q.Monsters.length)? q.Monsters.map(m=>`<span class="tag">${m}</span>`).join(' '):'<span class="tag">No monsters</span>';
                const rewards = document.createElement('div'); rewards.className='row'; rewards.innerHTML=(q.Rewards && q.Rewards.length)? q.Rewards.map(r=>`<span class="tag">${r.ItemName} x${r.Quantity}</span>`).join(' '):'<span class="tag">No rewards</span>';
                body.appendChild(mons); body.appendChild(rewards);
                card.appendChild(body);

                const actions = document.createElement('div'); actions.className='quest-actions';
                const editBtn = document.createElement('button'); editBtn.className='btn btn-primary'; editBtn.innerText='編集'; editBtn.onclick=()=>openEdit(idx);
                const delBtn = document.createElement('button'); delBtn.className='btn btn-danger'; delBtn.innerText='削除'; delBtn.onclick=()=>deleteQuest(idx);
                actions.appendChild(editBtn); actions.appendChild(delBtn);
                card.appendChild(actions);

                grid.appendChild(card);
            });

            document.getElementById('statusLeft').innerText = `Quests: ${filtered.length} / ${quests.length}`;
        }

        function openEdit(index){ const q = quests[index]; openAddModal(q); }
        function deleteQuest(index){ if(!confirm('Delete quest?')) return; quests.splice(index,1); renderList(); setStatus('Deleted'); }

        function setStatus(text){ document.getElementById('statusRight').innerText = text; }

        // drag/drop & sample
        function createSample(){ quests = [{ Name:'炎の洞窟討伐', Rank:2, Monsters:['Flame Dragon'], Rewards:[{ItemName:'Gold',Quantity:100},{ItemName:'Flame Scale',Quantity:1}] }, { Name:'スライム退治', Rank:1, Monsters:['Slime'], Rewards:[{ItemName:'Gold',Quantity:20},{ItemName:'Slime Jelly',Quantity:2}] }]; renderList(); setStatus('Sample created'); }

        function readFromText(text){ try{ quests = JSON.parse(text) || []; renderList(); setStatus('Loaded'); }catch(e){ alert('JSON parse error'); setStatus('Parse error'); }}

        function saveJSONToConsole(){ console.log(JSON.stringify(quests,null,2)); setStatus('Printed to console'); }

        function saveToClipboard(){ navigator.clipboard.writeText(JSON.stringify(quests,null,2)).then(()=>setStatus('Copied to clipboard')).catch(()=>setStatus('Clipboard failed')); }

        function readFileFromPath(path){ fetch(path).then(r=>r.text()).then(t=>readFromText(t)).catch(e=>setStatus('Fetch failed')); }

        function readFileFallback(){ /* not implemented */ }

        function readFileManual(){ fileInput.click(); }

        function saveToLocalStorage(){ localStorage.setItem('quests', JSON.stringify(quests)); setStatus('Saved locally'); }
        function loadFromLocalStorage(){ const data = localStorage.getItem('quests'); if(data) { quests = JSON.parse(data); renderList(); setStatus('Loaded from localStorage'); } }

        function exportBackup(){ const blob=new Blob([JSON.stringify(quests,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(currentFileName?currentFileName.replace('.json','')+'-backup.json':'quests-backup.json'); a.click(); setStatus('Backup exported'); }

        // quick init
        window.onload = ()=>{ loadFromLocalStorage(); renderList(); setStatus('Ready'); };
    </script>
</body>
</html>
